#!/bin/bash
#
##
###  _           _       _            _
### (_)___  ___ | | __ _| |_ ___  ___| |_
### | / __|/ _ \| |/ _` | __/ _ \/ __| __|
### | \__ \ (_) | | (_| | ||  __/\__ \ |_
### |_|___/\___/|_|\__,_|\__\___||___/\__|
###
###  _ _|_ _ ._    _  _
### (_\/|_(_)|_)\/(_|(/_
###   /      |  /  _|
###
### isolatest
### arch linux iso
### create bootable device with the latest archiso
### (c) 2019 cytopyge
###
##
#


# usage: isolatest [path_to_target_device]
# path to device is mandatory


# initialization

download_location="$HOME/download_"
target_device=$1
clear

# check for requirements

## not a mountpoint
mountpoint -q $target_device
if [[ $? -eq 0 ]] ; then
	printf "$target_device is a mountpoint\n"
	printf "exiting\n"
	exit
fi

## no valid directory path
if [[ -d $target_device ]] ; then
	printf "$target_device is a valid path\n"
	printf "exiting\n"
	exit
fi

## internet connection
if [ ! -z $(ping -q -w 2 -c 1 9.9.9.9 | grep -i unreachable) ]; then
	printf "internet connection detected via $(ip r | grep default | cut -d ' ' -f 3)\n"
else
	printf "no internet connection\n"
	printf "exiting\n"
	exit
fi

echo
printf "requirements check complete\n"
clear


# info and warning
printf "isolatest (c) 2019 cytopyge\n"
echo
## device info for human
lsblk --tree -o name,uuid,fstype,label,size,fsuse%,fsused,path,mountpoint
echo
printf "WARNING! about to \033[1mirreversible overwrite\033[0m $target_device\n"
echo
read -p "continue? (y/N) " -n 1 -r

if [[ $REPLY =~ ^[yY]$ ]] ; then
	clear
else
	echo
	printf "aborted by user\n"
	printf "exiting\n"
	exit
fi

# configuring the mirrorlist

sudo cp /etc/pacman.d/mirrorlist /etc/pacman.d/mirrorlist.old
echo
printf "selecting fastest mirror\n"
sudo reflector --verbose --country 'Netherlands' -l 5 --sort rate --save /etc/pacman.d/mirrorlist
source1=$(grep = /etc/pacman.d/mirrorlist | sed -n 1p | awk -F '= ' '{print $2}' | sed 's/$.*/iso\/latest/')
file1=$(curl -s $source1/sha1sums.txt | grep -o 'archlinux-.*-x86_64.iso')


# download

echo
printf "%27s %s\n" "image version:" "$file1"
printf "%27s %s\n" "downloading from:" "$source1"
printf "%27s %s\n" "writing iso to:" "$download_location"
cd $download_location
echo
printf "downloading...\n"
curl -O "$source1/$file1"


# sha1 checksum verification

## derive sha1 ist
sha1_ist=$(openssl dgst -sha1 $file1 | sed 's/^.*= //')
printf "$sha1_ist" > $file1.sha1_ist

## derive sha1 soll
sha1_soll=$(curl -s $source1/sha1sums.txt | grep $file1 | cut -d ' ' -f 1)

## report to human
echo
printf "checksum comparison\n"
printf "soll sha1: $sha1_soll\n"
printf "ist  sha1: $sha1_ist\n"

## checksum comparison and set status
[ "$sha1_soll" == "$sha1_ist" ] || checksum=0 # no checksum match
[ "$sha1_soll" == "$sha1_ist" ] && checksum=1 # checksum match

if [ $checksum == 0 ]; then
	printf "checksum error\n"
	printf "exiting\n"
	exit
	elif [ $checksum == 1 ] ; then
		printf "identical checksums\n"
fi

# write to usb
echo
printf "writing image to $target_device\n"
sudo dd if=$download_location/$file1 of=$target_device bs=4M status=progress oflag=sync

echo
printf "process complete\n"
echo
